<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunPilot Survey - Sports App Feedback</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* --- CORE LAYOUT FOR FULL-PAGE IFRAME --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Prevents the main page from scrolling */
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          background: #DDE1C8;
          display: flex;
          flex-direction: column;
        }

        .form-container {
          flex-grow: 1; /* Allows this container to fill available vertical space */
          display: flex;
          flex-direction: column;
          background: white;
          max-width: 800px;
          width: 100%;
          margin: 0 auto;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .form-embed {
          width: 100%;
          height: 100%; /* Make iframe fill its container */
          border: none;
          display: block;
        }

        .hero-image {
          width: 100%;
          display: block;
          object-fit: cover;
          max-height: 240px;
        }

        .hidden {
            display: none !important;
        }

        .loading-message, .error-message {
          text-align: center;
          padding: 50px 20px;
          color: #666;
          font-size: 1.1em;
        }
        .error-message { color: #ea4335; }
        .error-message a { color: #667eea; font-weight: bold; }


        /* --- NEW: COMPACT FLOATING REFERRAL BAR STYLES --- */
        .referral-bar {
            position: fixed; /* Floats on top of the page content */
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95); /* Slightly transparent */
            backdrop-filter: blur(5px); /* Frosted glass effect */
            border-top: 1px solid #dcdcdc;
            padding: 8px 15px; /* Reduced vertical padding for compactness */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000; /* Ensures it's on top of the iframe */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* Allows items to wrap on small screens */
            gap: 8px;
        }

        .referral-bar-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Language Flag Icons */
        .flag-icon {
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            user-select: none;
            border: 2px solid transparent;
        }

        .flag-icon:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: scale(1.1);
        }

        .flag-icon:active {
            transform: scale(0.95);
        }

        .flag-icon.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        /* Vertical Separator */
        .vertical-separator {
            width: 1px;
            height: 28px;
            background: #dcdcdc;
            margin: 0 4px;
        }

        /* Your Link Button */
        .btn-your-link {
            padding: 6px 12px;
            font-size: 0.85em;
            white-space: nowrap;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-your-link:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-your-link:active {
            transform: translateY(0);
        }

        /* Native Share Button */
        .btn-native-share {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0;
        }

        .btn-native-share:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-native-share:active {
            transform: translateY(0);
        }

        .btn-native-share svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .status-msg {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .status-msg.show {
            opacity: 1;
        }


        @media (max-width: 600px) {
            .referral-bar { gap: 6px; padding: 6px 10px; }
            .flag-icon { font-size: 20px; padding: 3px 6px; }
            .btn-native-share { width: 32px; height: 32px; }
            .btn-native-share svg { width: 18px; height: 18px; }
        }

        /* Language Switch Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-text {
            font-size: 1em;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .modal-btn-yes {
            background: #667eea;
            color: white;
        }

        .modal-btn-yes:hover {
            background: #5568d3;
        }

        .modal-btn-cancel {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-cancel:hover {
            background: #d0d0d0;
        }
    </style>
</head>
<body>
<!-- Google Form container -->
<div class="form-container" id="formContainer">
    <img src="funpilot_hero.jpg" alt="FunPilot - Sports Made Easy" class="hero-image" id="heroImage">
    <div class="loading-message" id="loadingMsg">üîÑ <span id="loadingText">Loading survey...</span></div>
    <iframe id="googleForm" class="form-embed" style="display: none;" frameborder="0" marginheight="0" marginwidth="0" onload="handleFormLoad()" onerror="handleFormError()"></iframe>
    <div class="error-message" id="errorMsg" style="display: none;">
        ‚ö†Ô∏è <span id="errorText">Could not load survey.</span><br>
        <a href="#" id="directFormLink" target="_blank"><span id="errorLinkText">Click here to open the survey directly</span></a>
    </div>
</div>

<!-- NEW: Compact Floating Referral Bar (Visible during the survey) -->
<div class="referral-bar" id="referralBar">
    <div class="referral-bar-content">
        <!-- Language Flags -->
        <span class="flag-icon" id="flagDE" onclick="switchLanguage('de')" title="Deutsch">üá©üá™</span>
        <span class="flag-icon" id="flagEN" onclick="switchLanguage('en')" title="English">üá¨üáß</span>

        <!-- Separator -->
        <div class="vertical-separator"></div>

        <!-- Your Link Button -->
        <button class="btn-your-link" onclick="copyLink()">
            üîó <span id="yourLinkText">Your Link</span>
        </button>

        <!-- Native Share Button -->
        <button class="btn-native-share" onclick="nativeShare()" id="shareButton" title="Share">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
            </svg>
        </button>
    </div>
    <div class="status-msg" id="copyStatus">‚úÖ <span id="copyStatusText">Link copied!</span></div>
</div>


<!-- Language Switch Confirmation Modal -->
<div class="modal-overlay" id="languageModal">
    <div class="modal-content">
        <div class="modal-text" id="modalText">Would you like to switch to English?</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLanguageModal()"><span id="modalCancelText">Cancel</span></button>
            <button class="modal-btn modal-btn-yes" onclick="confirmLanguageSwitch()"><span id="modalYesText">Yes</span></button>
        </div>
    </div>
</div>

<script>
    console.log('Script starting...');

    // --- Configuration ---
    const FORM_CONFIG = {
        de: {
            formId: "1FAIpQLSeQ8Z0slHeXLRrBcnu8gK_NAQx1qegHNRpfzIsvkFW1nZ4iuw",
            lang: "de"
        },
        en: {
            formId: "1FAIpQLSeX3Lud4s8L5dYt-DMcCWEL2Th1rXhGdE-mdzt_3fcmeZzmLw",
            lang: "en"
        }
    };

    // Entry IDs for both forms (same for German and English)
    const ENTRY_REFERRED_FROM = "265035231";  // Who referred this person
    const ENTRY_UNIQUE_ID = "123651617";      // This person's unique ID

    // Text translations
    const TRANSLATIONS = {
        de: {
            loadingText: "Umfrage wird geladen...",
            errorText: "Die Umfrage konnte nicht geladen werden.",
            errorLinkText: "Klicke hier, um die Umfrage direkt zu √∂ffnen",
            yourLinkText: "Dein Link",
            copyStatusText: "Link kopiert!",
            shareTitle: "FunPilot Umfrage",
            shareText: "üèÄ Stell dir vor: Du willst spielen, und es klappt einfach. FunPilot macht's m√∂glich. Sag uns, was du brauchst (dauert nur 3 Minuten):",
            modalSwitchToEN: "M√∂chten Sie zur englischen Version wechseln?",
            modalSwitchToDE: "M√∂chten Sie zur deutschen Version wechseln?",
            modalCancel: "Abbrechen",
            modalYes: "Ja"
        },
        en: {
            loadingText: "Loading survey...",
            errorText: "Could not load survey.",
            errorLinkText: "Click here to open the survey directly",
            yourLinkText: "Your Link",
            copyStatusText: "Link copied!",
            shareTitle: "FunPilot Survey",
            shareText: "üèÄ Imagine: You want to play, and it just works. FunPilot makes it happen. Tell us what you need (takes only 3 minutes):",
            modalSwitchToEN: "Would you like to switch to English?",
            modalSwitchToDE: "Would you like to switch to German?",
            modalCancel: "Cancel",
            modalYes: "Yes"
        }
    };

    // --- Get URL Parameters ---
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Extract "referred from" ID from URL (if someone clicked a referral link)
    const referredFromId = getUrlParameter('ref') || '';

    // --- Language Management ---
    let currentLanguage = localStorage.getItem('surveyLanguage') || 'de';
    let pendingLanguage = null;

    function updateLanguageUI() {
        // Update flag highlighting
        document.getElementById('flagDE').classList.toggle('active', currentLanguage === 'de');
        document.getElementById('flagEN').classList.toggle('active', currentLanguage === 'en');

        // Update all text elements
        const t = TRANSLATIONS[currentLanguage];
        document.getElementById('loadingText').textContent = t.loadingText;
        document.getElementById('errorText').textContent = t.errorText;
        document.getElementById('errorLinkText').textContent = t.errorLinkText;
        document.getElementById('yourLinkText').textContent = t.yourLinkText;
        document.getElementById('copyStatusText').textContent = t.copyStatusText;

        // Update HTML lang attribute
        document.documentElement.lang = currentLanguage;
    }

    function switchLanguage(targetLang) {
        if (targetLang === currentLanguage) {
            return; // Already in this language
        }

        // Show confirmation modal
        pendingLanguage = targetLang;
        const t = TRANSLATIONS[currentLanguage];
        const modalText = targetLang === 'en' ? t.modalSwitchToEN : t.modalSwitchToDE;

        document.getElementById('modalText').textContent = modalText;
        document.getElementById('modalCancelText').textContent = t.modalCancel;
        document.getElementById('modalYesText').textContent = t.modalYes;
        document.getElementById('languageModal').classList.add('show');
    }

    function closeLanguageModal() {
        document.getElementById('languageModal').classList.remove('show');
        pendingLanguage = null;
    }

    function confirmLanguageSwitch() {
        if (pendingLanguage) {
            currentLanguage = pendingLanguage;
            localStorage.setItem('surveyLanguage', currentLanguage);
            closeLanguageModal();
            updateLanguageUI();

            // Reload the form with new language
            loadForm();
        }
    }

    // --- Referral Code Logic ---
    // This generates and persists the unique referral ID for the current user
    // localStorage ensures it survives browser/computer restarts
    function generateUniqueCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'REF_';
      for (let i = 0; i < 6; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    let myReferralCode = localStorage.getItem('myReferralCode');
    if (!myReferralCode) {
      myReferralCode = generateUniqueCode();
      localStorage.setItem('myReferralCode', myReferralCode);
      console.log('Generated new referral code:', myReferralCode);
    } else {
      console.log('Using existing referral code from localStorage:', myReferralCode);
    }

    // The personal referral link that this user can share
    let LANDING_PAGE_URL = window.location.href.split('?')[0];
    const myReferralLink = `${LANDING_PAGE_URL}?ref=${encodeURIComponent(myReferralCode)}`;

    // --- Form URL Builder ---
    function buildFormUrl(lang, embedded = true) {
        const config = FORM_CONFIG[lang];
        const baseUrl = `https://docs.google.com/forms/d/e/${config.formId}/viewform`;
        const params = new URLSearchParams();

        // Enable pre-population (required for entry parameters to work)
        params.append('usp', 'pp_url');

        if (embedded) {
            params.append('embedded', 'true');
        }

        // Add referred from ID (who referred this person)
        if (referredFromId) {
            params.append(`entry.${ENTRY_REFERRED_FROM}`, referredFromId);
        }

        // Add unique ID (this person's referral code)
        params.append(`entry.${ENTRY_UNIQUE_ID}`, myReferralCode);

        return `${baseUrl}?${params.toString()}`;
    }

    // --- Load Form ---
    function loadForm() {
        const formUrl = buildFormUrl(currentLanguage, true);
        const iframe = document.getElementById('googleForm');
        iframe.src = formUrl;

        // Update direct link
        const directUrl = buildFormUrl(currentLanguage, false);
        document.getElementById('directFormLink').href = directUrl;

        console.log('=== FORM URL DEBUG ===');
        console.log('Referred from ID:', referredFromId || '(none - new visitor)');
        console.log('My referral code:', myReferralCode);
        console.log('Full form URL:', formUrl);
        console.log('Entry IDs: referred_from=' + ENTRY_REFERRED_FROM + ', unique_id=' + ENTRY_UNIQUE_ID);
    }

    // --- Form Load Handler ---
    function handleFormLoad() {
        console.log('Iframe onload event fired.');
        // Hide loading message and show the form
        document.getElementById('loadingMsg').style.display = 'none';
        document.getElementById('googleForm').style.display = 'block';
        document.getElementById('errorMsg').style.display = 'none';
    }

    function handleFormError() {
      console.error('Form failed to load');
      document.getElementById('loadingMsg').style.display = 'none';
      document.getElementById('googleForm').style.display = 'none';
      document.getElementById('errorMsg').style.display = 'block';
    }

    // --- Share and Copy Logic ---
    function nativeShare() {
        const t = TRANSLATIONS[currentLanguage];

        // Check if Web Share API is supported
        if (navigator.share) {
            navigator.share({
                title: t.shareTitle,
                text: t.shareText,
                url: myReferralLink
            })
            .then(() => {
                console.log('Shared successfully via Web Share API');
            })
            .catch((error) => {
                // User cancelled or error occurred
                if (error.name !== 'AbortError') {
                    console.log('Share failed, falling back to copy:', error);
                    fallbackShare();
                }
            });
        } else {
            // Fallback for browsers that don't support Web Share API
            console.log('Web Share API not supported, using fallback');
            fallbackShare();
        }
    }

    function fallbackShare() {
        // Fallback: copy share message + link to clipboard
        const t = TRANSLATIONS[currentLanguage];
        const fullMessage = `${t.shareText}\n${myReferralLink}`;

        console.log('Fallback share - copying full message:', fullMessage);

        // For older browsers like IE, always use textarea method
        // This is more reliable than navigator.clipboard on old browsers
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = fullMessage;
        tempTextarea.style.position = 'fixed';
        tempTextarea.style.top = '0';
        tempTextarea.style.left = '0';
        tempTextarea.style.width = '2em';
        tempTextarea.style.height = '2em';
        tempTextarea.style.padding = '0';
        tempTextarea.style.border = 'none';
        tempTextarea.style.outline = 'none';
        tempTextarea.style.boxShadow = 'none';
        tempTextarea.style.background = 'transparent';
        tempTextarea.style.opacity = '0';

        document.body.appendChild(tempTextarea);
        tempTextarea.focus();
        tempTextarea.select();

        try {
            const successful = document.execCommand('copy');
            console.log('Copy command result:', successful);
            if (successful) {
                showCopyStatus();
            } else {
                alert('Please copy this message:\n\n' + fullMessage);
            }
        } catch (err) {
            console.error('Copy failed:', err);
            alert('Please copy this message:\n\n' + fullMessage);
        }

        document.body.removeChild(tempTextarea);
    }

    function copyLink() {
      // Modern clipboard API with fallback for older browsers
      // Works on iOS, macOS, Android, and Windows
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(myReferralLink).then(() => {
          showCopyStatus();
        }).catch(err => {
          console.error('Clipboard API failed, using fallback:', err);
          fallbackCopy();
        });
      } else {
        fallbackCopy();
      }
    }

    function fallbackCopy() {
      // Fallback for older browsers and iOS Safari
      const tempInput = document.createElement('input');
      tempInput.value = myReferralLink;
      tempInput.style.position = 'fixed';
      tempInput.style.opacity = '0';
      document.body.appendChild(tempInput);
      tempInput.focus();
      tempInput.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopyStatus();
        }
      } catch (err) {
        console.error('Fallback copy failed:', err);
        alert('Copy failed. Please copy the link manually: ' + myReferralLink);
      }

      document.body.removeChild(tempInput);
    }

    function showCopyStatus() {
      const status = document.getElementById('copyStatus');
      status.classList.add('show');
      setTimeout(() => status.classList.remove('show'), 3000);
    }

    // --- Initialize ---
    console.log('Initializing...');
    console.log('Current language:', currentLanguage);
    console.log('Referred from ID:', referredFromId || 'none (new visitor)');
    console.log('My referral code:', myReferralCode);
    console.log('My referral link:', myReferralLink);
    console.log('Web Share API supported:', !!navigator.share);

    updateLanguageUI();
    loadForm();

    console.log('Script initialization complete');
    console.log('Note: Referral code persists in localStorage across browser restarts');
</script>
</body>
</html>
