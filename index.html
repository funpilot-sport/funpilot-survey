<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunPilot Umfrage - Sport-App Feedback</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          background: #DDE1C8;
          min-height: 100vh;
          padding: 0;
          overflow-x: hidden;
        }

        .form-container {
          background: white;
          max-width: 800px;
          width: 100%;
          margin: 0 auto;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          min-height: 100vh;
        }

        .form-embed {
          width: 100%;
          height: 100vh;
          border: none;
          display: block;
        }

        .loading-message {
          text-align: center;
          padding: 50px 20px;
          color: #666;
          font-size: 1.1em;
        }

        .error-message {
          text-align: center;
          padding: 50px 20px;
          color: #ea4335;
          font-size: 1em;
          line-height: 1.6;
        }

        .error-message a {
          color: #667eea;
          font-weight: bold;
        }

        .referral-section {
          background: white;
          max-width: 800px;
          width: 100%;
          margin: 0 auto;
          padding: 30px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .referral-header {
          color: #667eea;
          font-weight: bold;
          font-size: 1.1em;
          margin-bottom: 15px;
          text-align: center;
        }

        .link-box {
          background: #f8f9fa;
          padding: 12px;
          border-radius: 8px;
          margin: 15px 0;
          word-break: break-all;
          font-family: monospace;
          font-size: 0.8em;
          color: #555;
          border: 2px solid #667eea;
          max-height: 80px;
          overflow-y: auto;
        }

        .btn {
          border: none;
          padding: 12px 24px;
          font-size: 0.95em;
          border-radius: 8px;
          cursor: pointer;
          margin: 6px;
          transition: all 0.3s;
          text-decoration: none;
          display: inline-block;
          font-weight: 500;
        }

        .btn-copy {
          background: #667eea;
          color: white;
        }

        .btn-copy:hover {
          background: #5568d3;
          transform: translateY(-1px);
        }

        .btn-share {
          color: white;
          font-size: 0.9em;
          padding: 10px 18px;
        }

        .btn-whatsapp { background: #25d366; }
        .btn-whatsapp:hover { background: #20bd5a; }

        .btn-facebook { background: #3b5998; }
        .btn-facebook:hover { background: #334d84; }

        .btn-email { background: #ea4335; }
        .btn-email:hover { background: #d33426; }

        .btn-telegram { background: #0088cc; }
        .btn-telegram:hover { background: #0077b5; }

        .share-section {
          margin-top: 20px;
          text-align: center;
        }

        .share-label {
          font-size: 0.95em;
          color: #666;
          margin-bottom: 12px;
          font-weight: 500;
        }

        .status-msg {
          color: #10b981;
          font-weight: bold;
          font-size: 0.9em;
          margin-top: 10px;
          opacity: 0;
          transition: opacity 0.3s;
          text-align: center;
        }

        .status-msg.show { opacity: 1; }

        .bookmark-tip {
          margin-top: 30px;
          padding-top: 20px;
          border-top: 1px solid #e0e0e0;
          text-align: center;
          font-size: 0.7em;
          color: #888;
          line-height: 1.4;
        }

        @media (max-width: 600px) {
          .referral-section { padding: 20px; }
          .btn { font-size: 0.85em; padding: 10px 16px; margin: 4px; }
          .link-box { font-size: 0.7em; }
          .bookmark-tip { font-size: 0.65em; }
        }
    </style>
</head>
<body>
<!-- Google Form at the top -->
<div class="form-container">
    <div class="loading-message" id="loadingMsg">
        üîÑ Umfrage wird geladen...
    </div>
    <iframe
            id="googleForm"
            class="form-embed"
            style="display: none;"
            frameborder="0"
            marginheight="0"
            marginwidth="0"
            onload="handleFormLoad()"
            onerror="handleFormError()">
    </iframe>
    <div class="error-message" id="errorMsg" style="display: none;">
        ‚ö†Ô∏è Die Umfrage konnte nicht geladen werden.<br>
        <a href="#" id="directFormLink" target="_blank">Klicke hier, um die Umfrage direkt zu √∂ffnen</a>
    </div>
</div>

<!-- Referral section at the bottom -->
<div class="referral-section">
    <div class="referral-header">
        üéÅ Teile deinen pers√∂nlichen Link & erhalte 50% Rabatt
    </div>

    <div class="link-box" id="referralLink">Wird generiert...</div>

    <div style="text-align: center;">
        <button class="btn btn-copy" onclick="copyLink()">
            üìã Link kopieren
        </button>
    </div>

    <div class="status-msg" id="copyStatus">‚úÖ Link kopiert!</div>

    <div class="share-section">
        <div class="share-label">üì≤ Direkt teilen:</div>
        <a href="#" id="whatsappShare" class="btn btn-share btn-whatsapp" target="_blank">
            WhatsApp
        </a>
        <a href="#" id="facebookShare" class="btn btn-share btn-facebook" target="_blank">
            Facebook
        </a>
        <a href="#" id="telegramShare" class="btn btn-share btn-telegram" target="_blank">
            Telegram
        </a>
        <a href="#" id="emailShare" class="btn btn-share btn-email">
            Email
        </a>
    </div>

    <div class="bookmark-tip">
        üí° Tipp: Setze ein Lesezeichen (Strg+D / Cmd+D) auf diese Seite,<br>um deinen Link jederzeit wiederzufinden!
    </div>
</div>

<script>
    console.log('Script starting...');

    // Configuration
    const FORM_ID = "1FAIpQLSeQ8Z0slHeXLRrBcnu8gK_NAQx1qegHNRpfzIsvkFW1nZ4iuw";
    const FORM_BASE_URL = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform`;
    const FORM_EMBED_URL = `https://docs.google.com/forms/d/e/${FORM_ID}/viewform?embedded=true`;

    // Get current page URL (for referral links)
    let LANDING_PAGE_URL = window.location.href.split('?')[0]; // Remove any existing params
    console.log('Landing page URL:', LANDING_PAGE_URL);

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const referredBy = urlParams.get('ref');
    console.log('Referred by:', referredBy);

    // Generate unique referral code
    function generateUniqueCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = 'REF_';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Get or create referral code (persistent via localStorage)
    let myReferralCode = localStorage.getItem('myReferralCode');

    if (!myReferralCode) {
      myReferralCode = generateUniqueCode();
      localStorage.setItem('myReferralCode', myReferralCode);
      localStorage.setItem('referralCodeCreated', new Date().toISOString());
      console.log('Generated new code:', myReferralCode);
    } else {
      console.log('Using existing code:', myReferralCode);
    }

    // Build the referral link
    const myReferralLink = `${LANDING_PAGE_URL}?ref=${encodeURIComponent(myReferralCode)}`;
    console.log('My referral link:', myReferralLink);

    // Update the link display
    const linkElement = document.getElementById('referralLink');
    if (linkElement) {
      linkElement.textContent = myReferralLink;
      console.log('Link element updated');
    } else {
      console.error('Link element not found!');
    }

    // Build the Google Form URL with pre-populated data
    let formUrlWithParams = FORM_EMBED_URL;
    formUrlWithParams += `&entry.825929421=__other_option__&entry.825929421.other_option_response=${encodeURIComponent(myReferralCode)}`;

    console.log('Form URL:', formUrlWithParams);

    // Load the form in iframe
    const iframe = document.getElementById('googleForm');
    if (iframe) {
      iframe.src = formUrlWithParams;
      console.log('Iframe src set');
    } else {
      console.error('Iframe not found!');
    }

    // Set direct link fallback
    document.getElementById('directFormLink').href = formUrlWithParams.replace('embedded=true', '');

    // Handle form load success
    function handleFormLoad() {
      console.log('Form loaded successfully');
      document.getElementById('loadingMsg').style.display = 'none';
      document.getElementById('googleForm').style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }

    // Handle form load error
    function handleFormError() {
      console.error('Form failed to load');
      document.getElementById('loadingMsg').style.display = 'none';
      document.getElementById('googleForm').style.display = 'none';
      document.getElementById('errorMsg').style.display = 'block';
    }

    // Timeout fallback (if form takes too long)
    setTimeout(function() {
      const iframe = document.getElementById('googleForm');
      if (iframe.style.display === 'none') {
        console.log('Form loading timeout, showing iframe anyway');
        handleFormLoad();
      }
    }, 3000);

    // Share button setup
    const shareText = "‚öΩ Hilf mir, diese Sport-App zu verbessern! 2-Minuten-Umfrage f√ºr alle Hobbysportler:";
    const shareTextEncoded = encodeURIComponent(shareText);
    const linkEncoded = encodeURIComponent(myReferralLink);

    document.getElementById('whatsappShare').href =
      `https://wa.me/?text=${shareTextEncoded}%20${linkEncoded}`;

    document.getElementById('facebookShare').href =
      `https://www.facebook.com/sharer/sharer.php?u=${linkEncoded}`;

    document.getElementById('telegramShare').href =
      `https://t.me/share/url?url=${linkEncoded}&text=${shareTextEncoded}`;

    document.getElementById('emailShare').href =
      `mailto:?subject=${encodeURIComponent("Sport-App Umfrage")}&body=${shareTextEncoded}%0A%0A${linkEncoded}`;

    console.log('Share buttons configured');

    // Copy link function
    function copyLink() {
      console.log('Copy button clicked');
      navigator.clipboard.writeText(myReferralLink).then(() => {
        console.log('Copied to clipboard');
        showCopyStatus();
      }).catch(err => {
        console.log('Clipboard API failed, using fallback');
        const tempInput = document.createElement('input');
        tempInput.value = myReferralLink;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showCopyStatus();
      });
    }

    function showCopyStatus() {
      const status = document.getElementById('copyStatus');
      status.classList.add('show');
      setTimeout(() => status.classList.remove('show'), 3000);
    }

    console.log('Script initialization complete');
</script>
</body>
</html>
